@using System.Net.Http.Headers;
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using SharedClasses.Models
@inject HttpClient http
@inject NavigationManager navManager
@inject IJSRuntime JS
@inject ILogger<BadgeEditComponent> logger

<div class="mb-3">
    <img src="UploadedImages/@Badge.FileName" height="50" />
@*    <FileEdit Filter="image/jpeg, image/png, image/gif" Changed="@OnBadgeImageChanged" />*@
</div>
<div class="mb-3">
    <label for="titleInput" class="form-label">Title</label>
    <input type="text" class="form-control" id="titleInput" @bind="Badge.Title" placeholder="Title">
</div>
<div class="mb-3">
    <label for="descriptionInput" class="form-label">Description (Describe the skill associated with this badge)</label>
    <textarea class="form-control" @bind="Badge.Description"></textarea>
</div>
<div class="mb-3">
    <label for="turnInInstructionsInput" class="form-label">Turn in instructions (Describe what to do to turn in work to be evaluated. Make sure you include what email or teams page to turn work into.)</label>
    <textarea class="form-control" @bind="Badge.TurnInInstructions"></textarea>
</div>

<div class="mb-3">
    <EvaluatorSelectorComponent Badge="Badge" Evaluators ="evaluators"/>
</div>
<div class="mb-3">
    <button class="btn btn-primary" type="button" @onclick="OnSaveChangesClickedAsync">Save Changes</button>
    <button class="btn btn-danger" type="button" @onclick="OnCancelChangesClickedAsync">Discard Changes</button>
</div>

@code{
    [Parameter]
    public HSBadge Badge { get; set; } = new HSBadge();
    private IList<UploadResult> uploadResults = new List<UploadResult>();
    private List<string> evaluators = new List<string>();

    protected async override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        
    }

    protected async Task OnSaveChangesClickedAsync()
    {
        try
        {
            if (Badge.Id == 0)
            {
                var result = await http.PostAsJsonAsync<HSBadge>($"/api/Badges/", Badge);
                //TODO: Need to save evaluators
                if (result.IsSuccessStatusCode)
                {
                    logger.Log(LogLevel.Information,"Badge added");
                }
                else
                {
                    logger.Log(LogLevel.Information,$"Badge not added {result.ReasonPhrase}");
                }
            }
            else
            {
                var result = await http.PutAsJsonAsync<HSBadge>($"/api/Badges/", Badge);
                if (result.IsSuccessStatusCode)
                {
                    logger.Log(LogLevel.Information,$"Badge updated {result.ReasonPhrase}");
                }
                else
                {
                    logger.Log(LogLevel.Information,$"Badge not updated {result.ReasonPhrase}");
                }
            }

            var evalResult = await http.PostAsJsonAsync<List<String>>($"/api/Evaluators/AddUpdatedForBadge/{Badge?.Id}", evaluators ?? new List<string>());
            if (evalResult.IsSuccessStatusCode)
            {
                logger.Log(LogLevel.Information, "Evaluators added");
            }
            else
            {
                logger.Log(LogLevel.Information, $"Evaluators not added {evalResult.ReasonPhrase}");
            }
            navManager.NavigateTo("/badges");
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    protected async Task OnCancelChangesClickedAsync()
    {
        navManager.NavigateTo("/badges");
        await Task.CompletedTask;
    }
}
